name: CI

on:
    push:
        branches: [ main, develop ]
    pull_request:
        branches: [ main, develop ]

jobs:
    code-quality:
        name: Code Quality & Tests
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    java-version: '17'
                    distribution: 'temurin'

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v3

            -   name: Make gradlew executable
                run: chmod +x ./gradlew

            -   name: Run KtLint Check
                run: ./gradlew ktlintCheck

            -   name: Run Detekt
                run: ./gradlew detekt
                continue-on-error: true # Continue even if detekt finds issues

            -   name: Run Unit Tests
                run: ./gradlew test --continue
                continue-on-error: true # Continue even if some tests fail

            -   name: Upload KtLint Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: ktlint-reports
                    path: |
                        **/build/reports/ktlint/
                    retention-days: 30

            -   name: Upload Detekt Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: detekt-reports
                    path: |
                        **/build/reports/detekt/
                    retention-days: 30

            -   name: Upload Test Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: test-reports
                    path: |
                        **/build/reports/tests/
                        **/build/test-results/
                    retention-days: 30

            -   name: Comment PR with Results
                if: github.event_name == 'pull_request'
                uses: actions/github-script@v7
                with:
                    script: |
                        const fs = require('fs');
                        const path = require('path');

                        let comment = '## ü§ñ CI Results\n\n';

                        // Check if ktlint passed
                        const ktlintExitCode = ${{ job.status == 'success' ? '0' : '1' }};
                        if (ktlintExitCode === '0') {
                          comment += '‚úÖ **KtLint**: All checks passed\n';
                        } else {
                          comment += '‚ùå **KtLint**: Style violations found\n';
                        }

                        comment += '‚ö†Ô∏è **Detekt**: Check reports for analysis results\n';
                        comment += 'üß™ **Tests**: Check test reports for results\n\n';
                        comment += 'View detailed reports in the Actions artifacts.';

                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                        });
