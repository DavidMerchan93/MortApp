name: CI

on:
    push:
        branches: [ main, develop ]
    pull_request:
        branches: [ main, develop ]

jobs:
    code-quality:
        name: Code Quality & Tests
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    java-version: '17'
                    distribution: temurin

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v3

            -   name: Make gradlew executable
                run: chmod +x ./gradlew

            -   name: Run KtLint Check
                id: ktlint
                run: ./gradlew ktlintCheck
                continue-on-error: true

            -   name: Run Detekt
                id: detekt
                run: ./gradlew detekt
                continue-on-error: true

            -   name: Run Unit Tests
                id: tests
                run: ./gradlew test --continue
                continue-on-error: true

            -   name: Upload KtLint Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: ktlint-reports
                    path: |
                        **/build/reports/ktlint/
                    retention-days: 30

            -   name: Upload Detekt Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: detekt-reports
                    path: |
                        **/build/reports/detekt/
                    retention-days: 30

            -   name: Upload Test Reports
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: test-reports
                    path: |
                        **/build/reports/tests/
                        **/build/test-results/
                    retention-days: 30

            -   name: Comment PR with Results
                if: ${{ always() && github.event_name == 'pull_request' }}
                uses: actions/github-script@v7
                with:
                    github-token: ${{ secrets.GITHUB_TOKEN }}
                    script: |
                        const ktlint = '${{ steps.ktlint.outcome }}';   // success|failure|cancelled|skipped
                        const detekt = '${{ steps.detekt.outcome }}';
                        const tests  = '${{ steps.tests.outcome }}';

                        const badge = (outcome, name) => {
                          const ok = outcome === 'success';
                          const emoji = ok ? '✅' : (outcome === 'skipped' ? '⏭️' : '❌');
                          const text  = ok ? 'passed' : (outcome === 'skipped' ? 'skipped' : 'failed');
                          return `- ${emoji} **${name}**: ${text}`;
                        };

                        const body = [
                          '## 🤖 CI Results',
                          badge(ktlint, 'ktlint'),
                          badge(detekt, 'detekt'),
                          badge(tests,  'tests'),
                          '',
                          'Revisa los artefactos para ver los reportes detallados.'
                        ].join('\n');

                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body
                        });
